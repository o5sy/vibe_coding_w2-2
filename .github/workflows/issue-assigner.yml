name: Issue Auto Assigner

on:
  issues:
    types: [opened, labeled]

jobs:
  assign:
    runs-on: ubuntu-latest
    steps:
      - name: Auto assign issue
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const { number: issue_number } = context.issue;
            const issue = context.payload.issue;

            const title = issue.title.toLowerCase();
            const body = (issue.body || '').toLowerCase();
            const labels = issue.labels.map(label => label.name.toLowerCase());

            let assignees = [];
            let assignmentReason = '';

            // í‚¤ì›Œë“œ ê¸°ë°˜ ìë™ í• ë‹¹
            const backendKeywords = ['fastapi', 'api', 'server', 'backend', 'langgraph', 'agent', 'llm'];
            const frontendKeywords = ['streamlit', 'ui', 'frontend', 'interface', 'display'];
            const docKeywords = ['documentation', 'docs', 'readme', 'guide', 'manual'];
            const devopsKeywords = ['deploy', 'ci', 'cd', 'action', 'workflow', 'docker'];

            // ë°±ì—”ë“œ ê´€ë ¨ ì´ìŠˆ ì²´í¬
            const hasBackendKeywords = backendKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );

            // í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ ì´ìŠˆ ì²´í¬
            const hasFrontendKeywords = frontendKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );

            // ë¬¸ì„œ ê´€ë ¨ ì´ìŠˆ ì²´í¬
            const hasDocKeywords = docKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );

            // DevOps ê´€ë ¨ ì´ìŠˆ ì²´í¬
            const hasDevOpsKeywords = devopsKeywords.some(keyword => 
              title.includes(keyword) || body.includes(keyword)
            );

            // ë¼ë²¨ ê¸°ë°˜ í• ë‹¹
            const hasBackendLabel = labels.some(label => 
              label.includes('backend') || label.includes('api')
            );

            const hasFrontendLabel = labels.some(label => 
              label.includes('frontend') || label.includes('ui')
            );

            const hasDocLabel = labels.some(label => 
              label.includes('documentation') || label.includes('docs')
            );

            // í• ë‹¹ ë¡œì§ (ì‹¤ì œ ì‚¬ìš©ì‹œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
            if (hasBackendKeywords || hasBackendLabel) {
              // assignees.push('backend-maintainer');
              assignmentReason = 'ë°±ì—”ë“œ ê´€ë ¨ í‚¤ì›Œë“œ/ë¼ë²¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
              console.log('Backend issue detected - would assign to backend maintainer');
            } else if (hasFrontendKeywords || hasFrontendLabel) {
              // assignees.push('frontend-maintainer');
              assignmentReason = 'í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ í‚¤ì›Œë“œ/ë¼ë²¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
              console.log('Frontend issue detected - would assign to frontend maintainer');
            } else if (hasDocKeywords || hasDocLabel) {
              // assignees.push('docs-maintainer');
              assignmentReason = 'ë¬¸ì„œ ê´€ë ¨ í‚¤ì›Œë“œ/ë¼ë²¨ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
              console.log('Documentation issue detected - would assign to docs maintainer');
            } else if (hasDevOpsKeywords) {
              // assignees.push('devops-maintainer');
              assignmentReason = 'DevOps ê´€ë ¨ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤';
              console.log('DevOps issue detected - would assign to devops maintainer');
            }

            // ìš°ì„ ìˆœìœ„ ê¸°ë°˜ ì¶”ê°€ í• ë‹¹
            const isCritical = labels.includes('priority: critical') || 
                             title.includes('critical') || 
                             title.includes('urgent') ||
                             title.includes('ê¸´ê¸‰');

            if (isCritical) {
              // assignees.push('project-lead');  // í”„ë¡œì íŠ¸ ë¦¬ë“œ ì¶”ê°€
              assignmentReason += ' (ê¸´ê¸‰ ì´ìŠˆë¡œ í”„ë¡œì íŠ¸ ë¦¬ë“œ ì¶”ê°€ í• ë‹¹)';
              console.log('Critical issue - would also assign to project lead');
            }

            // ê¸°ë³¸ í• ë‹¹ì (ì•„ë¬´ë„ í• ë‹¹ë˜ì§€ ì•Šì€ ê²½ìš°)
            if (assignees.length === 0) {
              assignees.push(owner);
              assignmentReason = 'ê¸°ë³¸ í• ë‹¹ì (í”„ë¡œì íŠ¸ ì†Œìœ ì)';
            }

            // ì¤‘ë³µ ì œê±°
            assignees = [...new Set(assignees)];

            // ì´ìŠˆ ì‘ì„±ìëŠ” í• ë‹¹ìì—ì„œ ì œì™¸
            assignees = assignees.filter(assignee => assignee !== issue.user.login);

            console.log('Final assignees:', assignees);
            console.log('Assignment reason:', assignmentReason);

            // ì‹¤ì œ í• ë‹¹ (ì‚¬ìš©ìê°€ ì¡´ì¬í•  ë•Œë§Œ)
            try {
              if (assignees.length > 0) {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number,
                  assignees
                });
                console.log('Assigned:', assignees);
              }
            } catch (error) {
              console.log('Assignment failed (users might not exist):', error.message);
            }

            // í• ë‹¹ ì •ë³´ ëŒ“ê¸€
            const assignmentMessage = `## ğŸ¤– ìë™ í• ë‹¹ ì™„ë£Œ

            **í• ë‹¹ ê·¼ê±°**: ${assignmentReason}

            ### ğŸ” ê°ì§€ëœ í‚¤ì›Œë“œ/ë¼ë²¨
            ${hasBackendKeywords || hasBackendLabel ? '- ğŸ”§ ë°±ì—”ë“œ ê´€ë ¨\n' : ''}
            ${hasFrontendKeywords || hasFrontendLabel ? '- ğŸ¨ í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨\n' : ''}
            ${hasDocKeywords || hasDocLabel ? '- ğŸ“š ë¬¸ì„œ ê´€ë ¨\n' : ''}
            ${hasDevOpsKeywords ? '- âš™ï¸ DevOps ê´€ë ¨\n' : ''}
            ${isCritical ? '- ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ\n' : ''}

            ### ğŸ“‹ ë‹´ë‹¹ì ì—­í• 
            í• ë‹¹ëœ ë‹´ë‹¹ìëŠ” ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤:
            1. **ì´ìŠˆ ê²€í† **: ë‚´ìš©ê³¼ ìš”êµ¬ì‚¬í•­ íŒŒì•…
            2. **ìš°ì„ ìˆœìœ„ ì„¤ì •**: ë‹¤ë¥¸ ì‘ì—…ê³¼ì˜ ìš°ì„ ìˆœìœ„ ì¡°ì •
            3. **ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸**: ì •ê¸°ì ì¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            4. **í•´ê²° ë°©ì•ˆ ì œì‹œ**: êµ¬ì²´ì ì¸ í•´ê²° ê³„íš ìˆ˜ë¦½

            ### â° ì˜ˆìƒ ì‘ë‹µ ì‹œê°„
            - **ê¸´ê¸‰ ì´ìŠˆ**: 4ì‹œê°„ ë‚´
            - **ì¼ë°˜ ì´ìŠˆ**: 24-48ì‹œê°„ ë‚´
            - **ê¸°ëŠ¥ ìš”ì²­**: 3-5ì¼ ë‚´

            ë‹´ë‹¹ìê°€ ì ì ˆí•˜ì§€ ì•Šë‹¤ê³  ìƒê°ë˜ì‹œë©´ ì–¸ì œë“ ì§€ ì¬í• ë‹¹ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.

            ---
            *ì´ ëŒ“ê¸€ì€ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: assignmentMessage
            });
