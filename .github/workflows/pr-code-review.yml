name: PR Auto Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  code-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy bandit safety

      - name: Run code quality checks
        id: code-quality
        run: |
          echo "## ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼" > review_comments.md
          echo "" >> review_comments.md

          # Black í¬ë§·íŒ… ì²´í¬
          echo "### ğŸ“ ì½”ë“œ í¬ë§·íŒ… (Black)" >> review_comments.md
          if black --check --diff . > black_output.txt 2>&1; then
            echo "âœ… ì½”ë“œ í¬ë§·íŒ…ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤." >> review_comments.md
          else
            echo "âŒ ì½”ë“œ í¬ë§·íŒ…ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”:" >> review_comments.md
            echo '```diff' >> review_comments.md
            head -20 black_output.txt >> review_comments.md
            echo '```' >> review_comments.md
          fi
          echo "" >> review_comments.md

          # Import ì •ë ¬ ì²´í¬
          echo "### ğŸ“¦ Import ì •ë ¬ (isort)" >> review_comments.md
          if isort --check-only --diff . > isort_output.txt 2>&1; then
            echo "âœ… Import ì •ë ¬ì´ ì˜¬ë°”ë¦…ë‹ˆë‹¤." >> review_comments.md
          else
            echo "âŒ Import ì •ë ¬ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”:" >> review_comments.md
            echo '```diff' >> review_comments.md
            head -20 isort_output.txt >> review_comments.md
            echo '```' >> review_comments.md
          fi
          echo "" >> review_comments.md

          # Flake8 ë¦°íŒ…
          echo "### ğŸ”§ ì½”ë“œ ë¦°íŒ… (Flake8)" >> review_comments.md
          if flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics > flake8_output.txt 2>&1; then
            echo "âœ… ì‹¬ê°í•œ ë¦°íŒ… ì˜¤ë¥˜ê°€ ì—†ìŠµë‹ˆë‹¤." >> review_comments.md
          else
            echo "âŒ ë‹¤ìŒ ë¦°íŒ… ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•´ì£¼ì„¸ìš”:" >> review_comments.md
            echo '```' >> review_comments.md
            cat flake8_output.txt >> review_comments.md
            echo '```' >> review_comments.md
          fi
          echo "" >> review_comments.md

          # ë³´ì•ˆ ì²´í¬ (Bandit)
          echo "### ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)" >> review_comments.md
          if bandit -r . -f json > bandit_output.json 2>/dev/null; then
            HIGH_ISSUES=$(cat bandit_output.json | python3 -c "import json,sys;data=json.load(sys.stdin);print(len([r for r in data.get('results',[]) if r.get('issue_severity')=='HIGH']))")
            MEDIUM_ISSUES=$(cat bandit_output.json | python3 -c "import json,sys;data=json.load(sys.stdin);print(len([r for r in data.get('results',[]) if r.get('issue_severity')=='MEDIUM']))")
            
            if [ "$HIGH_ISSUES" -eq 0 ] && [ "$MEDIUM_ISSUES" -eq 0 ]; then
              echo "âœ… ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> review_comments.md
            else
              echo "âš ï¸ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:" >> review_comments.md
              echo "- ë†’ìŒ: $HIGH_ISSUESê°œ" >> review_comments.md
              echo "- ë³´í†µ: $MEDIUM_ISSUESê°œ" >> review_comments.md
              echo "" >> review_comments.md
              echo "ìì„¸í•œ ë‚´ìš©ì€ Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> review_comments.md
            fi
          else
            echo "âœ… ë³´ì•ˆ ê²€ì‚¬ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤." >> review_comments.md
          fi
          echo "" >> review_comments.md

          # ì¢…ì†ì„± ë³´ì•ˆ ì²´í¬ (Safety)
          echo "### ğŸ›¡ï¸ ì¢…ì†ì„± ë³´ì•ˆ ê²€ì‚¬ (Safety)" >> review_comments.md
          if find . -name "requirements*.txt" -exec safety check -r {} \; > safety_output.txt 2>&1; then
            echo "âœ… ì•Œë ¤ì§„ ë³´ì•ˆ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤." >> review_comments.md
          else
            echo "âš ï¸ ë³´ì•ˆ ì·¨ì•½ì ì´ ìˆëŠ” íŒ¨í‚¤ì§€ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:" >> review_comments.md
            echo '```' >> review_comments.md
            head -10 safety_output.txt >> review_comments.md
            echo '```' >> review_comments.md
          fi

      - name: Analyze code complexity
        run: |
          echo "" >> review_comments.md
          echo "### ğŸ§® ì½”ë“œ ë³µì¡ë„ ë¶„ì„" >> review_comments.md

          # íŒŒì´ì¬ íŒŒì¼ë“¤ì˜ ë¼ì¸ ìˆ˜ ì²´í¬
          PYTHON_FILES=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" | wc -l)
          TOTAL_LINES=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -exec wc -l {} + | tail -1 | awk '{print $1}')

          echo "- Python íŒŒì¼ ìˆ˜: $PYTHON_FILESê°œ" >> review_comments.md
          echo "- ì´ ì½”ë“œ ë¼ì¸ ìˆ˜: $TOTAL_LINESì¤„" >> review_comments.md

          # í° íŒŒì¼ë“¤ ì°¾ê¸°
          echo "" >> review_comments.md
          echo "**í° íŒŒì¼ë“¤ (200ì¤„ ì´ìƒ):**" >> review_comments.md
          find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -exec wc -l {} + | sort -nr | head -5 | while read lines file; do
            if [ "$lines" -gt 200 ]; then
              echo "- $file: ${lines}ì¤„" >> review_comments.md
            fi
          done

      - name: Check for common issues
        run: |
          echo "" >> review_comments.md
          echo "### âš ï¸ ì¼ë°˜ì ì¸ ì´ìŠˆ ì²´í¬" >> review_comments.md

          # TODO/FIXME ì°¾ê¸°
          TODO_COUNT=$(grep -r "TODO\|FIXME\|XXX" --include="*.py" . | wc -l || echo "0")
          echo "- TODO/FIXME ì£¼ì„: ${TODO_COUNT}ê°œ" >> review_comments.md

          # print ë¬¸ ì°¾ê¸° (ë¡œê¹… ëŒ€ì‹  print ì‚¬ìš©)
          PRINT_COUNT=$(grep -r "print(" --include="*.py" . | grep -v "__pycache__" | wc -l || echo "0")
          if [ "$PRINT_COUNT" -gt 0 ]; then
            echo "- âš ï¸ print() ë¬¸ ë°œê²¬: ${PRINT_COUNT}ê°œ (ë¡œê¹… ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤)" >> review_comments.md
          fi

          # í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ë‚˜ í‚¤ íŒ¨í„´ ì²´í¬
          SECRET_PATTERNS="password\|secret\|key\|token\|api_key"
          SECRET_COUNT=$(grep -ri "$SECRET_PATTERNS" --include="*.py" . | grep -v "__pycache__" | grep -E "(=|:)" | wc -l || echo "0")
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "- âš ï¸ ì ì¬ì  ë¹„ë°€ì •ë³´ í•˜ë“œì½”ë”©: ${SECRET_COUNT}ê°œ (í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©ì„ ê¶Œì¥í•©ë‹ˆë‹¤)" >> review_comments.md
          fi

      - name: Generate code review suggestions
        run: |
          echo "" >> review_comments.md
          echo "### ğŸ’¡ ê°œì„  ì œì•ˆ" >> review_comments.md
          echo "" >> review_comments.md

          # íŒŒì¼ ë³€ê²½ì‚¬í•­ ê¸°ë°˜ ì œì•ˆ
          echo "**ì½”ë“œ í’ˆì§ˆ í–¥ìƒì„ ìœ„í•œ ì œì•ˆ:**" >> review_comments.md
          echo "1. ğŸ§ª í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ ë†’ì—¬ë³´ì„¸ìš”" >> review_comments.md
          echo "2. ğŸ“ ë…ìŠ¤íŠ¸ë§ì„ ì¶”ê°€í•˜ì—¬ ì½”ë“œ ë¬¸ì„œí™”ë¥¼ ê°œì„ í•´ë³´ì„¸ìš”" >> review_comments.md
          echo "3. ğŸ”§ íƒ€ì… íŒíŠ¸ë¥¼ ì¶”ê°€í•˜ì—¬ ì½”ë“œ ì•ˆì •ì„±ì„ ë†’ì—¬ë³´ì„¸ìš”" >> review_comments.md
          echo "4. ğŸš€ ì„±ëŠ¥ì´ ì¤‘ìš”í•œ ë¶€ë¶„ì—ëŠ” í”„ë¡œíŒŒì¼ë§ì„ ê³ ë ¤í•´ë³´ì„¸ìš”" >> review_comments.md
          echo "5. ğŸ”’ ë¯¼ê°í•œ ì •ë³´ëŠ” í™˜ê²½ë³€ìˆ˜ë¡œ ê´€ë¦¬í•´ë³´ì„¸ìš”" >> review_comments.md
          echo "" >> review_comments.md
          echo "---" >> review_comments.md
          echo "*ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ ì§ˆë¬¸ì´ ìˆìœ¼ì‹œë©´ ì–¸ì œë“ ì§€ ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”!*" >> review_comments.md

      - name: Post code review
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const { number: pull_number } = context.issue;

            // ë¦¬ë·° ëŒ“ê¸€ ì½ê¸°
            const reviewContent = fs.readFileSync('review_comments.md', 'utf8');

            // ê¸°ì¡´ ë´‡ ëŒ“ê¸€ ì°¾ê¸°
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pull_number
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼')
            );

            if (botComment) {
              // ê¸°ì¡´ ëŒ“ê¸€ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body: reviewContent
              });
            } else {
              // ìƒˆ ëŒ“ê¸€ ìƒì„±
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pull_number,
                body: reviewContent
              });
            }
